services:
  postgres_test:
    image: postgres:15-alpine
    container_name: tea_postgres_test
    environment:
      POSTGRES_DB: tea_test
      POSTGRES_USER: tea_user
      POSTGRES_PASSWORD: tea_password
    tmpfs:
      - /var/lib/postgresql/data # Use tmpfs for faster performance
    networks:
      - tea_test_network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U tea_user -d tea_test']
      interval: 5s
      timeout: 3s
      retries: 3

  tea_app_test:
    build:
      context: .
      dockerfile: Dockerfile.dev
    container_name: tea_app_test
    depends_on:
      postgres_test:
        condition: service_healthy
    env_file:
      - ./.env.local
    volumes:
      - .:/app
      - app_test_modules:/app/node_modules # Separate node_modules
      - app_test_next:/app/.next # Separate .next build
      - app_test_coverage:/app/coverage # Separate coverage directory
    networks:
      - tea_test_network
    # Default: keep container running for interactive testing
    command:
      sh -c "if [ -f pnpm-lock.yaml ]; then corepack enable pnpm && pnpm dev; else npm run dev; fi"

networks:
  tea_test_network:
    driver: bridge

volumes:
  app_test_modules:
  app_test_next:
  app_test_coverage:
