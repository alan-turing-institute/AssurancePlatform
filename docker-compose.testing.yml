services:
  postgres_test:
    image: postgres:15-alpine
    container_name: tea_postgres_test
    environment:
      POSTGRES_DB: tea_test
      POSTGRES_USER: tea_user
      POSTGRES_PASSWORD: tea_password
    tmpfs:
      - /var/lib/postgresql/data # Use tmpfs for faster performance
    networks:
      - tea_test_network
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U tea_user -d tea_test']
      interval: 5s
      timeout: 3s
      retries: 3

  tea_backend_test:
    build:
      context: ./tea_backend
      dockerfile: Dockerfile.dev
    container_name: tea_backend_test
    hostname: tea-backend-test
    ports:
      - '8001:8000' # Different port to avoid conflicts
    depends_on:
      postgres_test:
        condition: service_healthy
    env_file:
      - ./tea_backend/.env.local
    volumes:
      - ./tea_backend:/app
      - ./tea_backend/mediafiles:/app/mediafiles
    networks:
      - tea_test_network
    # Use the same entrypoint script as development
    entrypoint: ['/app/docker-entrypoint-dev.sh']

  tea_frontend_test:
    build:
      context: ./tea_frontend
      dockerfile: Dockerfile.dev
    container_name: tea_frontend_test
    depends_on:
      - tea_backend_test
    env_file:
      - ./tea_frontend/.env.local
    volumes:
      - ./tea_frontend:/app
      - frontend_test_modules:/app/node_modules # Separate node_modules
      - frontend_test_next:/app/.next # Separate .next build
      - frontend_test_coverage:/app/coverage # Separate coverage directory
    networks:
      - tea_test_network
    # Default: keep container running for interactive testing
    command:
      sh -c "if [ -f pnpm-lock.yaml ]; then corepack enable pnpm && pnpm dev; else npm run dev; fi"

networks:
  tea_test_network:
    driver: bridge

volumes:
  frontend_test_modules:
  frontend_test_next:
  frontend_test_coverage:
